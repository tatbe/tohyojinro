<!DOCTYPE html>
<html lang="jp">
    <head>
        <meta charset="utf-8">
        <title>tohyoJinro</title>
        <script type="text/javascript" src="../js/jquery-3.3.1.min.js"></script>
    </head>
    <body>
        <div class="page-title">■結果</div>
        <div id="winningOrLosing"></div>
        <div id="roleList" style="display: none;"></div>
        <div>今回の投票結果</div>
        <div id="resultArea"></div>
        <div id="nextTurnLinkArea" style="display: none;">
            <button id="nextTurn"></button>
        </div>
        <div id="nextGameLinkArea" style="display: none;">
            <button id="nextGame">次のゲームへ</button>
            <button id="linkTop">TOPに戻る</button>
        <div>
    </body>
    <script type="text/javascript">
        var players = JSON.parse(localStorage.getItem('players'));
        var turn = localStorage.getItem('turn');
        // ターン数を減算
        var newTurn = Number(turn);
        newTurn--;
        // ローカルストレージにセット
        localStorage.setItem("turn", newTurn);
        var pattern = localStorage.getItem('pattern');
        console.log('ローカルストレージ', players);

        var resultArr = [];
        $.each(players, function(i, data) {
            var count = 0;
            $.each(data.answer, function(j, answer) {
                if (answer.role == true && answer.turn == turn) {
                    count++;
                }
            });
            resultArr.push(count);
            var html = '<div>' + data.name + 'さん　' + count + '票</div>';
            $('#resultArea').append(html);
        });
        // 投票結果文字列生成
        var resultPattern = '';
        (function () {
            resultArr.sort(function(a,b){
                if( a > b ) return -1;
                if( a < b ) return 1;
                return 0;
            });
            
            for(var i = 0; resultArr.length > i; i++) {
                resultPattern += resultArr[i];
                if (i != resultArr.length - 1) {
                    resultPattern += '×';
                }
            }
        }());
        // 指定投票パターンと照合結果描画
        var resultMatch = false;
        var resultMatchText = '';
        if (resultPattern == pattern) { // 指定投票パターン照合
            resultMatch = true;
        }
        // 勝敗結果判定
        if (resultMatch) {
            resultMatchText = '正解！ 村人チーム勝利！';
            $('#nextTurnLinkArea').hide();
            $('#nextGameLinkArea').show();
            cleateRoleList();
            $('#roleList').show();
        } else if (!resultMatch && newTurn < 1) {
            resultMatchText = '不正解 人狼チーム勝利';
            $('#nextTurnLinkArea').hide();
            $('#nextGameLinkArea').show();
            cleateRoleList();
            $('#roleList').show();
        } else {
            resultMatchText = '不正解...';
            $('#nextTurn').text('次のセッションへ（あと' + newTurn + '回）');
            $('#nextTurnLinkArea').show();
            $('#nextGameLinkArea').hide();
        }
        var html2 = '';
        html2 += '<div>' + resultMatchText + '</div>'
        html2 += '<div>結果：' + resultPattern + '</div>';
        html2 += '<div>指定投票パターン：' + pattern + '</div>';
        $('#winningOrLosing').append(html2);



        // ローカルストレージリセット処理
        function dataReset() {
            var newData = [];
            $.each(players, function(i, data) {
                var obj = {
                    name: data.name,
                    role: '',
                    answer: []
                }
                newData.push(obj);
            });

            // ローカルストレージにセット
            localStorage.setItem("players", JSON.stringify(newData));
        }

        // 役職一覧描画処理
        function cleateRoleList() {
            var html3 = '';
            $.each(players, function(i, data) {
                html3 += '<div>' + data.name + 'さん→' + data.role + '</div>';
            });
            $('#roleList').append(html3);
        }

        // 【一時的】dataReset();
        
        // 次のセッションへボタンクリックイベント
        $('#nextTurn').click(function() {
            // 画面遷移
            window.location.href = "./play.html";
        });
        // 次のゲームへボタンクリックイベント
        $('#nextGame').click(function() {
            // 画面遷移
            window.location.href = "./setting.html";
        });

        // TOPへ戻るボタンクリックイベント
        $('#linkTop').click(function() {
            // 画面遷移
            window.location.href = "./index.html";
        });
    </script>
</html>


