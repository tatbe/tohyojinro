<!DOCTYPE html>
<html lang="jp">
    <head>
        <meta charset="utf-8">
        <title>tohyoJinro</title>
        <link rel="stylesheet" type="text/css" href="../css/styles.css">
        <script type="text/javascript" src="../js/jquery-3.3.1.min.js"></script>
    </head>
    <body>
        <div class="page-title">â– çµæœ</div>
        <div id="winningOrLosing"></div>
        <div id="roleList" style="display: none;"></div>
        <div>ä»Šå›ã®æŠ•ç¥¨çµæœ</div>
        <div id="resultArea"></div>
        <div id="nextTurnLinkArea" style="display: none;">
            <button id="nextTurn"></button>
        </div>
        <div id="nextGameLinkArea" style="display: none;">
            <button id="nextGame">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸</button>
            <button id="linkTop">TOPã«æˆ»ã‚‹</button>
        <div>
    </body>
    <script type="text/javascript">
        var players = JSON.parse(localStorage.getItem('players'));
        var turn = localStorage.getItem('turn');
        // ã‚¿ãƒ¼ãƒ³æ•°ã‚’æ¸›ç®—
        var newTurn = Number(turn);
        newTurn--;
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚»ãƒƒãƒˆ
        localStorage.setItem("turn", newTurn);
        var pattern = localStorage.getItem('pattern');
        console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸', players);

        var resultArr = [];
        $.each(players, function(i, data) {
            var count = 0;
            $.each(data.answer, function(j, answer) {
                if (answer.role == true && answer.turn == turn) {
                    count++;
                }
            });
            resultArr.push(count);
            var html = '<div>' + data.name + 'ã•ã‚“ã€€' + count + 'ç¥¨</div>';
            $('#resultArea').append(html);
        });
        // æŠ•ç¥¨çµæœæ–‡å­—åˆ—ç”Ÿæˆ
        var resultPattern = '';
        (function () {
            resultArr.sort(function(a,b){
                if( a > b ) return -1;
                if( a < b ) return 1;
                return 0;
            });
            
            for(var i = 0; resultArr.length > i; i++) {
                resultPattern += resultArr[i];
                if (i != resultArr.length - 1) {
                    resultPattern += 'Ã—';
                }
            }
        }());
        // æŒ‡å®šæŠ•ç¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç…§åˆçµæœæç”»
        var resultMatch = false;
        var resultMatchText = '';
        if (resultPattern == pattern) { // æŒ‡å®šæŠ•ç¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ç…§åˆ
            resultMatch = true;
        }
        // å‹æ•—çµæœåˆ¤å®š
        if (resultMatch) {
            resultMatchText = '<b>æ­£è§£ï¼ ğŸ‰æ‘äººãƒãƒ¼ãƒ å‹åˆ©ï¼</b>';
            $('#nextTurnLinkArea').hide();
            $('#nextGameLinkArea').show();
            cleateRoleList();
            $('#roleList').show();
        } else if (!resultMatch && newTurn < 1) {
            resultMatchText = '<b>ä¸æ­£è§£ ğŸ‰äººç‹¼ãƒãƒ¼ãƒ å‹åˆ©</b>';
            $('#nextTurnLinkArea').hide();
            $('#nextGameLinkArea').show();
            cleateRoleList();
            $('#roleList').show();
        } else {
            resultMatchText = '<b>ä¸æ­£è§£...</b>';
            $('#nextTurn').text('æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ï¼ˆã‚ã¨' + newTurn + 'å›ï¼‰');
            $('#nextTurnLinkArea').show();
            $('#nextGameLinkArea').hide();
        }
        var html2 = '';
        html2 += '<div>' + resultMatchText + '</div>'
        html2 += '<div>çµæœï¼š' + resultPattern + '</div>';
        html2 += '<div>æŒ‡å®šæŠ•ç¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š' + pattern + '</div>';
        $('#winningOrLosing').append(html2);



        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        function dataReset() {
            var newData = [];
            $.each(players, function(i, data) {
                var obj = {
                    name: data.name,
                    role: '',
                    answer: []
                }
                newData.push(obj);
            });

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚»ãƒƒãƒˆ
            localStorage.setItem("players", JSON.stringify(newData));
        }

        // å½¹è·ä¸€è¦§æç”»å‡¦ç†
        function cleateRoleList() {
            var html3 = '';
            $.each(players, function(i, data) {
                html3 += '<div>' + data.name + 'ã•ã‚“â†’' + data.role + '</div>';
            });
            $('#roleList').append(html3);
        }

        // ã€ä¸€æ™‚çš„ã€‘dataReset();
        
        // æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#nextTurn').click(function() {
            // ç”»é¢é·ç§»
            window.location.href = "./play.html";
        });
        // æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#nextGame').click(function() {
            // ç”»é¢é·ç§»
            window.location.href = "./setting.html";
        });

        // TOPã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#linkTop').click(function() {
            // ç”»é¢é·ç§»
            window.location.href = "./index.html";
        });
    </script>
</html>


